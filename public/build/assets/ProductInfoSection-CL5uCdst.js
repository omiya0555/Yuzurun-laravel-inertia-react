import{h as f,r as m,a as C,j as e}from"./app-DPh2l7GI.js";import{e as _,d as p,f as j,h as E,b as $,c as I,s as k}from"./firebaseConfig-COc0cFUU.js";import D from"./MessageModal-Ui6focjX.js";import M from"./ProductInfoCard-icNEU_nS.js";async function O(s,a,l){const t=`${s.id}_${a.id}`;try{console.log("チャットルームの存在を確認しています...");const r=_(p,"chat_rooms",t),u=await j(r);let c="";try{const o=JSON.parse(s.image_urls||"[]");c=o.length>0?o[0]:"https://placehold.jp/300x300.png"}catch(o){console.error("画像URLの解析エラー:",o)}if(u.exists()){if(!confirm("チャットルームが既に存在します。チャットルームに移動しますか？")){console.log("キャンセルされました。元の画面に留まります。");return}}else await E(r,{id:t,product_title:s.title,product_top_image_url:c,buyer_id:a.id,buyer_name:a.name,seller_id:s.seller_id,seller_name:s.seller?s.seller.name:"Unknown"}),console.log("新しいチャットルームを作成しました。"),await $(I(p,`chat_rooms/${t}/chat_messages`),{product_title:s.title,user_id:a.id,user_name:a.name,message:l,created_at:k()}),console.log("最初のメッセージを送信しました。");f.get(`/chat/room/${t}`,{},{onSuccess:()=>{console.log("チャットルームに遷移しました。")},onError:o=>{console.error("エラー:",o)}})}catch(r){console.error("エラーが発生しました:",r)}}function P({product:s,isSeller:a,user:l}){const[t,r]=m.useState(s.transaction_status),[u,c]=m.useState(!1),[o,w]=m.useState(!1),{data:h,setData:S,submit:v,processing:x}=C({product_id:s.id,new_status:s.transaction_status});m.useEffect(()=>{(async()=>{const i=`${s.id}_${l.id}`,d=_(p,"chat_rooms",i);(await j(d)).exists()&&w(!0)})()},[s.id,l.id]);const g=n=>{S("new_status",parseInt(n.target.value))},b=n=>{n.preventDefault(),confirm("ステータスを変更しますか？")&&v("put",`/products/${s.id}/status`,{onSuccess:()=>{console.log("ステータス変更が成功しました"),r(h.new_status)},onError:i=>{console.error("ステータス変更エラー:",i)}})},y=()=>{c(!0)},R=async({method:n,message:i})=>{c(!1),n==="chat"?await O(s,l,i):f.post("/chat/send-link",{email:l.email,method:n},{onSuccess:d=>{alert("メールが送信されました！")},onError:d=>{console.error("メール送信エラー:",d),alert("メールの送信に失敗しました。")}})},N=()=>{const n=`${s.id}_${l.id}`;f.get(`/chat/room/${n}`)};return e.jsxs("div",{className:"max-w-[400px] min-w-[320px] mx-auto space-y-6 bg-stone-100",children:[e.jsx(M,{product:s,transactionStatus:t}),e.jsx("div",{className:"flex flex-col space-y-4 sm:space-y-0 sm:flex-row sm:justify-center sm:space-x-4",children:a?e.jsx(e.Fragment,{children:t===0?e.jsxs("form",{onSubmit:b,className:"flex flex-col w-full space-y-4",children:[e.jsxs("select",{className:"px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-200",value:h.new_status,onChange:g,required:!0,children:[e.jsx("option",{value:"",children:"変更を選択"}),e.jsx("option",{value:"1",children:"予約中"}),e.jsx("option",{value:"2",children:"取引完了"})]}),e.jsx("button",{type:"submit",className:"bg-blue-600 w-full text-white font-bold py-2 px-6 rounded-md hover:bg-blue-800 transition",disabled:x,children:"変更を確定する"})]}):t===1?e.jsxs("form",{onSubmit:b,className:"flex flex-col w-full space-y-4",children:[e.jsxs("select",{className:"px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-200",value:h.new_status,onChange:g,required:!0,children:[e.jsx("option",{value:"",children:"変更を選択"}),e.jsx("option",{value:"0",children:"出品中"}),e.jsx("option",{value:"2",children:"取引完了"})]}),e.jsx("button",{type:"submit",className:"bg-blue-600 w-full text-white font-bold py-2 px-6 rounded-md hover:bg-blue-800 transition",disabled:x,children:"変更を確定する"})]}):e.jsx("p",{className:"text-green-600 w-full font-bold text-center",children:"取引は完了しています。"})}):e.jsx(e.Fragment,{children:o?e.jsx("button",{onClick:N,className:"bg-green-600 w-full text-white font-bold py-2 px-6 rounded-md hover:bg-green-800 transition",children:"チャットルームへ移動"}):t===0?e.jsx("button",{onClick:y,className:"bg-blue-600 w-full text-white font-bold py-2 px-6 rounded-md hover:bg-blue-800 transition",disabled:x,children:"取引を申請する"}):e.jsx("p",{className:"text-green-600 font-bold text-center",children:"取引は完了しています。"})})}),e.jsx(D,{isOpen:u,onClose:()=>c(!1),onSubmit:R})]})}export{P as default};
